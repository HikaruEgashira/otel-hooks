"""Datadog provider using ddtrace SDK."""

from __future__ import annotations

import json
from pathlib import Path

from ddtrace import tracer

from otel_hooks.domain.transcript import Turn
from otel_hooks.providers.common import build_turn_payload


class DatadogProvider:
    def __init__(self, service: str = "otel-hooks", env: str | None = None) -> None:
        tracer.configure(service=service)
        if env:
            tracer.set_tags({"env": env})

    def emit_turn(self, session_id: str, turn_num: int, turn: Turn, transcript_path: Path | None, source_tool: str = "") -> None:
        payload = build_turn_payload(turn)
        tags: dict[str, str] = {
            "session.id": session_id,
            "gen_ai.system": "otel-hooks",
            "gen_ai.request.model": payload.model,
            "gen_ai.prompt": payload.user_text,
            "gen_ai.completion": payload.assistant_text,
        }
        if transcript_path is not None:
            tags["transcript_path"] = str(transcript_path)
        if source_tool:
            tags["source_tool"] = source_tool
        with tracer.trace(
            "ai_session.turn",
            resource=f"Turn {turn_num}",
            service="otel-hooks",
            span_type="llm",
        ) as root_span:
            root_span.set_tags(tags)

            with tracer.trace(
                "ai_session.generation",
                resource="Assistant Response",
                service="otel-hooks",
                span_type="llm",
            ) as gen_span:
                gen_span.set_tags(
                    {
                        "gen_ai.request.model": payload.model,
                        "gen_ai.prompt": payload.user_text,
                        "gen_ai.completion": payload.assistant_text,
                        "gen_ai.usage.tool_count": str(len(payload.tool_calls)),
                    }
                )

            for tc in payload.tool_calls:
                in_str = tc.input if isinstance(tc.input, str) else json.dumps(tc.input, ensure_ascii=False)
                with tracer.trace(
                    "ai_session.tool",
                    resource=tc.name,
                    service="otel-hooks",
                    span_type="tool",
                ) as tool_span:
                    tool_span.set_tags(
                        {
                            "tool.name": tc.name,
                            "tool.id": tc.id,
                            "tool.input": in_str,
                            "tool.output": tc.output or "",
                        }
                    )

    def flush(self) -> None:
        tracer.flush()

    def shutdown(self) -> None:
        tracer.shutdown()
